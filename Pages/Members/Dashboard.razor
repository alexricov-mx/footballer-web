@page "/members/dashboard"
@using FootballerWeb.Services
@using Microsoft.AspNetCore.Components
@using FootballerWeb.Shared.Components
@inject IJSRuntime JSRuntime
@inject IAuthService AuthService
@inject IJwtClientService JwtClientService
@inject UsuarioService UsuarioService
@inject NavigationManager Navigation

<AuthGuard>
    <div class="members-container">
        <div class="members-header">
            <div class="container-fluid">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="members-title">
                            <i class="oi oi-shield text-primary me-3"></i>
                            √Årea de Miembros
                        </h1>
                        <p class="members-subtitle">Bienvenido @userName</p>
                        <div class="user-status">
                            <span class="badge bg-success">‚úÖ Autenticado</span>
                            <span class="text-muted ms-2">@userEmail</span>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <LogoutButton 
                            ButtonText="Cerrar Sesi√≥n" 
                            CssClass="btn btn-outline-light"
                            ShowConfirmation="true" 
                            ConfirmationMessage="¬øEst√°s seguro de que deseas cerrar sesi√≥n? Perder√°s el acceso al √°rea de miembros." />
                    </div>
                </div>
            </div>
        </div>

        <div class="members-content p-4">
            <div class="container-fluid">
                <!-- Stats Cards -->
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-content">
                                <div class="stat-icon">
                                    <i class="oi oi-trophy text-warning"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>5</h3>
                                    <p>Torneos</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-content">
                                <div class="stat-icon">
                                    <i class="oi oi-people text-info"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>12</h3>
                                    <p>Equipos</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-content">
                                <div class="stat-icon">
                                    <i class="oi oi-graph text-success"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>89</h3>
                                    <p>Partidos</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-content">
                                <div class="stat-icon">
                                    <i class="oi oi-star text-danger"></i>
                                </div>
                                <div class="stat-info">
                                    <h3>4.8</h3>
                                    <p>Rating</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">üöÄ Acciones R√°pidas</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3 mb-2">
                                        <a href="#" class="btn btn-primary w-100">
                                            <i class="oi oi-plus"></i> Crear Torneo
                                        </a>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <a href="#" class="btn btn-outline-primary w-100">
                                            <i class="oi oi-people"></i> Gestionar Equipos
                                        </a>
                                    </div>
                                    <div class="col-md-3 mb-2">
                                        <a href="#" class="btn btn-outline-primary w-100">
                                            <i class="oi oi-calendar"></i> Ver Calendario
                                        </a>
                                    </div>
                                    @if (userRole == "super_admin" || userRole == "admin")
                                    {
                                        <div class="col-md-3 mb-2">
                                            <a href="/members/usuarios" class="btn btn-outline-warning w-100">
                                                <i class="oi oi-person"></i> Gestionar Usuarios
                                            </a>
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="col-md-3 mb-2">
                                            <a href="#" class="btn btn-outline-primary w-100">
                                                <i class="oi oi-bar-chart"></i> Estad√≠sticas
                                            </a>
                                        </div>
                                    }
                                </div>
                                
                                <!-- Debug completo temporalmente -->
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <div class="card border-warning">
                                            <div class="card-header bg-warning text-dark">
                                                <h6 class="mb-0">üîç Debug - Informaci√≥n de Rol del Usuario</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <strong>Rol encontrado:</strong> '@userRole'<br>
                                                        <strong>Es admin?</strong> @(userRole == "super_admin" || userRole == "admin" ? "S√≠" : "No")<br>
                                                        <strong>Token encontrado?</strong> @(debugTokenFound ? "S√≠" : "No")<br>
                                                        <strong>Token key usado:</strong> @debugTokenKey<br>
                                                        <strong>UserInfo encontrado?</strong> @(debugUserInfoFound ? "S√≠" : "No")
                                                    </div>
                                                    <div class="col-md-6">
                                                        <strong>Claims encontrados:</strong><br>
                                                        @if (debugClaimsFound.Any())
                                                        {
                                                            @foreach(var claim in debugClaimsFound)
                                                            {
                                                                <small>@claim</small><br>
                                                            }
                                                        }
                                                        else
                                                        {
                                                            <small class="text-muted">No hay claims</small>
                                                        }
                                                    </div>
                                                </div>
                                                @if (!string.IsNullOrEmpty(debugUserInfoContent))
                                                {
                                                    <hr>
                                                    <strong>UserInfo completo:</strong><br>
                                                    <code>@debugUserInfoContent</code>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- JWT Token Info -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">üîí Informaci√≥n de Sesi√≥n JWT</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <strong>Estado:</strong> 
                                        <span class="badge bg-success ms-2">Autenticado con JWT</span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>V√°lido hasta:</strong> 
                                        <span class="text-muted">@tokenExpiration</span>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <strong>Emisor:</strong> <span class="text-muted">@tokenIssuer</span>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Audiencia:</strong> <span class="text-muted">@tokenAudience</span>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Expira:</strong> <span class="text-muted">@tokenExpirationDate</span>
                                    </div>
                                </div>
                                
                                <hr>
                                
                                <h6 class="mb-3">üìã Claims del Token JWT</h6>
                                @if (userClaims.Any())
                                {
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width: 30%">Claim</th>
                                                    <th style="width: 70%">Valor</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var claim in userClaims.Take(10))
                                                {
                                                    <tr>
                                                        <td>
                                                            <span class="badge bg-light text-dark">@claim.Key</span>
                                                        </td>
                                                        <td>
                                                            @if (claim.Key.Contains("picture") || claim.Key.Contains("Foto"))
                                                            {
                                                                <img src="@claim.Value" alt="Avatar" class="rounded-circle me-2" style="width: 32px; height: 32px;" referrerpolicy="no-referrer" crossorigin="anonymous" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMTYiIGN5PSIxNiIgcj0iMTYiIGZpbGw9IiNEQ0RDREMiLz4KPHN2ZyB4PSI4IiB5PSI4IiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0iI0ZGRiI+CjxwYXRoIGQ9Ik0xMiAyQzEzLjEgMiAxNCAyLjkgMTQgNEMxNCA1LjEgMTMuMSA2IDEyIDZDMTAuOSA2IDEwIDUuMSAxMCA0QzEwIDIuOSAxMC45IDIgMTIgMlpNMjEgOVYyMkM2IDIyIDMgMTkgMyA5QzMgOC41IDMuMTggOCA0IDhIMjBDMjAuODIgOCAyMSA4LjUgMjEgOVpNMTIgMTFDMTIgMTEgNiAxNSA2IDE2QzYgMTcgNyAxNyAxOCAxN1YxMUgxMloiLz4KPHN2Zz4K';">
                                                                <small class="text-muted">@claim.Value</small>
                                                            }
                                                            else if (claim.Key.Contains("email_verified") || claim.Key.Contains("Email Verificado"))
                                                            {
                                                                @if (claim.Value.ToLower() == "true")
                                                                {
                                                                    <span class="badge bg-success">‚úÖ Verificado</span>
                                                                }
                                                                else
                                                                {
                                                                    <span class="badge bg-warning">‚ö†Ô∏è No verificado</span>
                                                                }
                                                            }
                                                            else if (claim.Key.Contains("Expiraci√≥n") || claim.Key.Contains("exp"))
                                                            {
                                                                <span class="text-info">@claim.Value</span>
                                                            }
                                                            else
                                                            {
                                                                <code class="text-primary">@claim.Value</code>
                                                            }
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    @if (userClaims.Count > 10)
                                    {
                                        <div class="mt-2">
                                            <button class="btn btn-sm btn-outline-secondary" @onclick="ToggleShowAllClaims">
                                                @if (showAllClaims)
                                                {
                                                    <i class="oi oi-chevron-top"></i><text> Mostrar menos</text>
                                                }
                                                else
                                                {
                                                    <i class="oi oi-chevron-bottom"></i><text> Mostrar todos (@userClaims.Count claims)</text>
                                                }
                                            </button>
                                        </div>
                                        
                                        @if (showAllClaims)
                                        {
                                            <div class="table-responsive mt-3">
                                                <table class="table table-sm table-hover">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th style="width: 30%">Claim</th>
                                                            <th style="width: 70%">Valor</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @foreach (var claim in userClaims.Skip(10))
                                                        {
                                                            <tr>
                                                                <td>
                                                                    <span class="badge bg-light text-dark">@claim.Key</span>
                                                                </td>
                                                                <td>
                                                                    <code class="text-primary">@claim.Value</code>
                                                                </td>
                                                            </tr>
                                                        }
                                                    </tbody>
                                                </table>
                                            </div>
                                        }
                                    }
                                }
                                else
                                {
                                    <div class="alert alert-info">
                                        <i class="oi oi-info"></i> No se encontraron claims en el token.
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</AuthGuard>

<style>
    .members-container {
        min-height: 100vh;
        background: #f8f9fa;
    }

    .members-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
    }

    .members-title {
        font-size: 2.5rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .members-subtitle {
        font-size: 1.2rem;
        opacity: 0.9;
        margin-bottom: 1rem;
    }

    .user-status {
        margin-top: 0.5rem;
    }

    .members-content {
        padding: 2rem 0;
    }

    .stat-card {
        background: white;
        border-radius: 15px;
        padding: 1.5rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        height: 100%;
        transition: transform 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
    }

    .stat-content {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .stat-icon {
        font-size: 2rem;
    }

    .stat-info h3 {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0;
        color: #2c3e50;
    }

    .stat-info p {
        margin-bottom: 0;
        color: #6c757d;
        font-weight: 500;
    }

    .card {
        border: none;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .card-header {
        background: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        border-radius: 15px 15px 0 0 !important;
    }
</style>

@code {
    private string userName = string.Empty;
    private string userEmail = string.Empty;
    private string userRole = string.Empty;
    private string tokenExpiration = string.Empty;
    private string tokenIssuer = string.Empty;
    private string tokenAudience = string.Empty;
    private string tokenExpirationDate = string.Empty;
    private Dictionary<string, string> userClaims = new();
    private bool showAllClaims = false;

    // Debug variables
    private bool debugTokenFound = false;
    private string debugTokenKey = string.Empty;
    private bool debugUserInfoFound = false;
    private List<string> debugClaimsFound = new();
    private string debugUserInfoContent = string.Empty;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadUserDataAsync();
            StateHasChanged();
        }
    }

    private async Task LoadUserDataAsync()
    {
        try
        {
            // Reset debug info
            debugTokenFound = false;
            debugTokenKey = string.Empty;
            debugUserInfoFound = false;
            debugClaimsFound.Clear();
            debugUserInfoContent = string.Empty;

            // Try different token keys
            string? token = null;
            
            var jwtToken = await JSRuntime.InvokeAsync<string?>("localStorage.getItem", "jwt_token");
            if (!string.IsNullOrEmpty(jwtToken))
            {
                token = jwtToken;
                debugTokenKey = "jwt_token";
            }
            else
            {
                var authToken = await JSRuntime.InvokeAsync<string?>("localStorage.getItem", "authToken");
                if (!string.IsNullOrEmpty(authToken))
                {
                    token = authToken;
                    debugTokenKey = "authToken";
                }
                else
                {
                    var basicToken = await JSRuntime.InvokeAsync<string?>("localStorage.getItem", "token");
                    if (!string.IsNullOrEmpty(basicToken))
                    {
                        token = basicToken;
                        debugTokenKey = "token";
                    }
                }
            }
            
            debugTokenFound = !string.IsNullOrEmpty(token);
            
            if (!string.IsNullOrEmpty(token))
            {
                // Get user info from token
                userName = JwtClientService.GetUserNameFromToken(token) ?? "Usuario";
                userEmail = JwtClientService.GetUserEmailFromToken(token) ?? "";
                
                // Get user role from claims - try multiple claim names
                var claims = JwtClientService.GetClaimsFromToken(token);
                
                // Debug: recopilar todos los claims disponibles
                if (claims != null)
                {
                    foreach (var claim in claims.Claims)
                    {
                        debugClaimsFound.Add($"{claim.Type}: {claim.Value}");
                    }
                }
                
                // Primero intentar obtener el rol de los claims JWT
                userRole = claims?.FindFirst("role")?.Value ?? 
                          claims?.FindFirst("http://schemas.microsoft.com/ws/2008/06/identity/claims/role")?.Value ??
                          claims?.FindFirst("roles")?.Value ??
                          claims?.FindFirst("user_role")?.Value ?? "";
                
                // Si no hay rol en el JWT, obtenerlo desde la base de datos usando el email
                if (string.IsNullOrEmpty(userRole) && !string.IsNullOrEmpty(userEmail))
                {
                    debugClaimsFound.Add($"attempting_db_role_lookup_for: {userEmail}");
                    try
                    {
                        var roleFromDb = await UsuarioService.GetUserRoleByEmailAsync(userEmail);
                        debugClaimsFound.Add($"db_role_response: {roleFromDb ?? "null"}");
                        if (!string.IsNullOrEmpty(roleFromDb))
                        {
                            userRole = roleFromDb;
                            debugClaimsFound.Add($"role_from_db_success: {roleFromDb}");
                        }
                        else
                        {
                            debugClaimsFound.Add("db_role_empty_or_null");
                        }
                    }
                    catch (Exception ex)
                    {
                        debugClaimsFound.Add($"error_getting_role: {ex.Message}");
                        debugClaimsFound.Add($"error_type: {ex.GetType().Name}");
                    }
                }
                else
                {
                    if (!string.IsNullOrEmpty(userRole))
                    {
                        debugClaimsFound.Add($"role_found_in_jwt: {userRole}");
                    }
                    if (string.IsNullOrEmpty(userEmail))
                    {
                        debugClaimsFound.Add("no_email_found_for_db_lookup");
                    }
                }
                
                // For testing, let's also check user info from localStorage
                var userInfo = await JSRuntime.InvokeAsync<string?>("localStorage.getItem", "userInfo");
                debugUserInfoFound = !string.IsNullOrEmpty(userInfo);
                
                if (!string.IsNullOrEmpty(userInfo))
                {
                    debugUserInfoContent = userInfo;
                    
                    if (string.IsNullOrEmpty(userRole))
                    {
                        try
                        {
                            var userObj = System.Text.Json.JsonSerializer.Deserialize<Dictionary<string, object>>(userInfo);
                            if (userObj != null && userObj.ContainsKey("rol"))
                            {
                                userRole = userObj["rol"].ToString() ?? "";
                            }
                        }
                        catch { /* ignore parsing errors */ }
                    }
                }
                
                // Get all token information
                var expirationDate = JwtClientService.GetTokenExpirationDate(token);
                tokenExpiration = expirationDate?.ToString("dd/MM/yyyy HH:mm") ?? "No disponible";
                tokenExpirationDate = expirationDate?.ToString("HH:mm:ss") ?? "No disponible";
                tokenIssuer = JwtClientService.GetTokenIssuer(token) ?? "No disponible";
                tokenAudience = JwtClientService.GetTokenAudience(token) ?? "No disponible";
                
                // Get all claims
                userClaims = JwtClientService.GetAllClaimsFromToken(token);
            }
        }
        catch (Exception ex)
        {
            // Log error but don't redirect - AuthenticatedRoute handles authentication
            Console.WriteLine($"Error loading user data: {ex.Message}");
        }
    }

    private void ToggleShowAllClaims()
    {
        showAllClaims = !showAllClaims;
    }
}